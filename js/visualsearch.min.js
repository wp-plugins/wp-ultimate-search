(function(){var e=jQuery;if(!window.VS)window.VS={};if(!VS.app)VS.app={};if(!VS.ui)VS.ui={};if(!VS.model)VS.model={};if(!VS.utils)VS.utils={};VS.VERSION="0.4.0";VS.VisualSearch=function(t){var n={container:"",query:"",autosearch:true,unquotable:[],remainder:"text",showFacets:true,callbacks:{search:e.noop,focus:e.noop,blur:e.noop,facetMatches:e.noop,valueMatches:e.noop}};this.options=_.extend({},n,t);this.options.callbacks=_.extend({},n.callbacks,t.callbacks);VS.app.hotkeys.initialize();this.searchQuery=new VS.model.SearchQuery;this.searchBox=new VS.ui.SearchBox({app:this,showFacets:this.options.showFacets});if(t.container){var r=this.searchBox.render().el;e(this.options.container).html(r)}this.searchBox.value(this.options.query||"");e(window).bind("unload",function(e){});return this};VS.init=function(e){return new VS.VisualSearch(e)}})();(function(){var e=jQuery;VS.ui.SearchBox=Backbone.View.extend({id:"search",events:{"click .VS-cancel-search-box":"clearSearch","mousedown .VS-search-box":"maybeFocusSearch","dblclick .VS-search-box":"highlightSearch","click .VS-search-box":"maybeTripleClick"},initialize:function(){this.app=this.options.app;this.flags={allSelected:false};this.facetViews=[];this.inputViews=[];_.bindAll(this,"renderFacets","_maybeDisableFacets","disableFacets","deselectAllFacets","addedFacet","removedFacet","changedFacet");this.app.searchQuery.bind("reset",this.renderFacets).bind("add",this.addedFacet).bind("remove",this.removedFacet).bind("change",this.changedFacet);e(document).bind("keydown",this._maybeDisableFacets)},render:function(){e(this.el).append(JST["search_box"]({}));e(document.body).setMode("no","search");return this},value:function(e){if(e==null)return this.serialize();return this.setQuery(e)},serialize:function(){var e=[];var t=this.inputViews.length;this.app.searchQuery.each(_.bind(function(t,n){e.push(this.inputViews[n].value());e.push(t.serialize())},this));if(t){e.push(this.inputViews[t-1].value())}return _.compact(e).join(" ")},selected:function(){return _.select(this.facetViews,function(e){return e.modes.editing=="is"||e.modes.selected=="is"})},selectedModels:function(){return _.pluck(this.selected(),"model")},setQuery:function(e){this.currentQuery=e;VS.app.SearchParser.parse(this.app,e)},viewPosition:function(e){var t=e.type=="facet"?this.facetViews:this.inputViews;var n=_.indexOf(t,e);if(n==-1)n=0;return n},searchEvent:function(e){var t=this.value();this.focusSearch(e);this.value(t);this.app.options.callbacks.search(t,this.app.searchQuery)},addFacet:function(e,t,n){e=VS.utils.inflector.trim(e);t=VS.utils.inflector.trim(t||"");if(!e)return;var r=new VS.model.SearchFacet({category:e,value:t||"",app:this.app});this.app.searchQuery.add(r,{at:n})},addedFacet:function(e){this.renderFacets();var t=_.detect(this.facetViews,function(t){if(t.model==e)return true});_.defer(function(){t.enableEdit()})},changedFacet:function(){this.renderFacets()},removedFacet:function(e,t,n){},renderFacets:function(){this.facetViews=[];this.inputViews=[];this.$(".VS-search-inner").empty();this.app.searchQuery.each(_.bind(this.renderFacet,this));this.renderSearchInput();this.renderPlaceholder()},renderFacet:function(e,t){var n=new VS.ui.SearchFacet({app:this.app,model:e,order:t});this.renderSearchInput();this.facetViews.push(n);this.$(".VS-search-inner").children().eq(t*2).after(n.render().el);n.calculateSize();_.defer(_.bind(n.calculateSize,n));return n},renderSearchInput:function(){var e=new VS.ui.SearchInput({position:this.inputViews.length,app:this.app,showFacets:this.options.showFacets});this.$(".VS-search-inner").append(e.render().el);this.inputViews.push(e)},renderPlaceholder:function(){var e=this.$(".VS-placeholder");if(this.app.searchQuery.length){e.addClass("VS-hidden")}else{e.removeClass("VS-hidden").text(this.app.options.placeholder)}},clearSearch:function(e){var t=_.bind(function(){this.disableFacets();this.value("");this.flags.allSelected=false;this.searchEvent(e);this.focusSearch(e)},this);if(this.app.options.callbacks.clearSearch){this.app.options.callbacks.clearSearch(t)}else{t()}},selectAllFacets:function(){this.flags.allSelected=true;e(document).one("click.selectAllFacets",this.deselectAllFacets);_.each(this.facetViews,function(e,t){e.selectFacet()});_.each(this.inputViews,function(e,t){e.selectText()})},allSelected:function(e){if(e)this.flags.allSelected=false;return this.flags.allSelected},deselectAllFacets:function(t){this.disableFacets();if(this.$(t.target).is(".category,input")){var n=e(t.target).closest(".search_facet,.search_input");var r=_.detect(this.facetViews.concat(this.inputViews),function(e){return e.el==n[0]});if(r.type=="facet"){r.selectFacet()}else if(r.type=="input"){_.defer(function(){r.enableEdit(true)})}}},disableFacets:function(t){_.each(this.inputViews,function(e){if(e&&e!=t&&(e.modes.editing=="is"||e.modes.selected=="is")){e.disableEdit()}});_.each(this.facetViews,function(e){if(e&&e!=t&&(e.modes.editing=="is"||e.modes.selected=="is")){e.disableEdit();e.deselectFacet()}});this.flags.allSelected=false;this.removeFocus();e(document).unbind("click.selectAllFacets")},resizeFacets:function(e){_.each(this.facetViews,function(t,n){if(!e||t==e){t.resize()}})},_maybeDisableFacets:function(e){if(this.flags.allSelected&&VS.app.hotkeys.key(e)=="backspace"){e.preventDefault();this.clearSearch(e);return false}else if(this.flags.allSelected&&VS.app.hotkeys.printable(e)){this.clearSearch(e)}},focusNextFacet:function(e,t,n){n=n||{};var r=this.facetViews.length;var i=n.viewPosition||this.viewPosition(e);if(!n.skipToFacet){if(e.type=="text"&&t>0)t-=1;if(e.type=="facet"&&t<0)t+=1}else if(n.skipToFacet&&e.type=="text"&&r==i&&t>=0){return false}var s,o=Math.min(r,i+t);if(e.type=="text"){if(o>=0&&o<r){s=this.facetViews[o]}else if(o==r){s=this.inputViews[this.inputViews.length-1]}if(s&&n.selectFacet&&s.type=="facet"){s.selectFacet()}else if(s){s.enableEdit();s.setCursorAtEnd(t||n.startAtEnd)}}else if(e.type=="facet"){if(n.skipToFacet){if(o>=r||o<0){s=_.last(this.inputViews);s.enableEdit()}else{s=this.facetViews[o];s.enableEdit();s.setCursorAtEnd(t||n.startAtEnd)}}else{s=this.inputViews[o];s.enableEdit()}}if(n.selectText)s.selectText();this.resizeFacets();return true},maybeFocusSearch:function(t){if(e(t.target).is(".VS-search-box")||e(t.target).is(".VS-search-inner")||t.type=="keydown"){this.focusSearch(t)}},focusSearch:function(e,t){var n=this.inputViews[this.inputViews.length-1];n.enableEdit(t);if(!t)n.setCursorAtEnd(-1);if(e.type=="keydown"){n.keydown(e);n.box.trigger("keydown")}_.defer(_.bind(function(){if(!this.$("input:focus").length){n.enableEdit(t)}},this))},highlightSearch:function(t){if(e(t.target).is(".VS-search-box")||e(t.target).is(".VS-search-inner")||t.type=="keydown"){var n=this.inputViews[this.inputViews.length-1];n.startTripleClickTimer();this.focusSearch(t,true)}},maybeTripleClick:function(e){var t=this.inputViews[this.inputViews.length-1];return t.maybeTripleClick(e)},addFocus:function(){this.app.options.callbacks.focus();this.$(".VS-search-box").addClass("VS-focus")},removeFocus:function(){this.app.options.callbacks.blur();var e=_.any(this.facetViews.concat(this.inputViews),function(e){return e.isFocused()});if(!e)this.$(".VS-search-box").removeClass("VS-focus")},showFacetCategoryMenu:function(e){e.preventDefault();e.stopPropagation();if(this.facetCategoryMenu&&this.facetCategoryMenu.modes.open=="is"){return this.facetCategoryMenu.close()}var t=[{title:"Account",onClick:_.bind(this.addFacet,this,"account","")},{title:"Project",onClick:_.bind(this.addFacet,this,"project","")},{title:"Filter",onClick:_.bind(this.addFacet,this,"filter","")},{title:"Access",onClick:_.bind(this.addFacet,this,"access","")}];var n=this.facetCategoryMenu||(this.facetCategoryMenu=new dc.ui.Menu({items:t,standalone:true}));this.$(".VS-icon-search").after(n.render().open().content);return false}})})();(function(){var e=jQuery;VS.ui.SearchFacet=Backbone.View.extend({type:"facet",className:"search_facet",events:{"click .category":"selectFacet","keydown input":"keydown","mousedown input":"enableEdit","mouseover .VS-icon-cancel":"showDelete","mouseout .VS-icon-cancel":"hideDelete","click .VS-icon-cancel":"remove"},initialize:function(e){this.flags={canClose:false};_.bindAll(this,"set","keydown","deselectFacet","deferDisableEdit")},render:function(){e(this.el).html(JST["search_facet"]({model:this.model}));this.setMode("not","editing");this.setMode("not","selected");this.box=this.$("input");this.box.val(this.model.label());this.box.bind("blur",this.deferDisableEdit);this.box.bind("input propertychange",this.keydown);this.setupAutocomplete();return this},calculateSize:function(){this.box.autoGrowInput();this.box.unbind("updated.autogrow");this.box.bind("updated.autogrow",_.bind(this.moveAutocomplete,this))},resize:function(e){this.box.trigger("resize.autogrow",e)},setupAutocomplete:function(){this.box.autocomplete({source:_.bind(this.autocompleteValues,this),minLength:0,delay:0,autoFocus:true,position:{offset:"0 5"},create:_.bind(function(t,n){e(this.el).find(".ui-autocomplete-input").css("z-index","auto")},this),select:_.bind(function(e,t){e.preventDefault();var n=this.model.get("value");this.set(t.item.value);if(n!=t.item.value||this.box.val()!=t.item.value){if(this.options.app.options.autosearch){this.search(e)}else{this.options.app.searchBox.renderFacets();this.options.app.searchBox.focusNextFacet(this,1,{viewPosition:this.options.order})}}return false},this),open:_.bind(function(t,n){var r=this.box;this.box.autocomplete("widget").find(".ui-menu-item").each(function(){var t=e(this),n=t.data("item.autocomplete")||t.data("ui-autocomplete-item");if(n["value"]==r.val()&&r.data("uiAutocomplete").menu.activate){r.data("uiAutocomplete").menu.activate(new e.Event("mouseover"),t)}})},this)});this.box.autocomplete("widget").addClass("VS-interface")},moveAutocomplete:function(){var e=this.box.data("uiAutocomplete");if(e){e.menu.element.position({my:"left top",at:"left bottom",of:this.box.data("uiAutocomplete").element,collision:"flip",offset:"0 5"})}},searchAutocomplete:function(e){var t=this.box.data("uiAutocomplete");if(t){var n=t.menu.element;t.search();n.outerWidth(Math.max(n.width("").outerWidth(),t.element.outerWidth()))}},closeAutocomplete:function(){var e=this.box.data("uiAutocomplete");if(e)e.close()},autocompleteValues:function(t,n){var r=this.model.get("category");var i=this.model.get("value");var s=t.term;this.options.app.options.callbacks.valueMatches(r,s,function(t,r){r=r||{};t=t||[];if(s&&i!=s){if(r.preserveMatches){n(t)}else{var o=VS.utils.inflector.escapeRegExp(s||"");var u=new RegExp("\\b"+o,"i");t=e.grep(t,function(e){return u.test(e)||u.test(e.value)||u.test(e.label)})}}if(r.preserveOrder){n(t)}else{n(_.sortBy(t,function(e){if(e==i||e.value==i)return"";else return e}))}})},set:function(e){if(!e)return;this.model.set({value:e})},search:function(e,t){if(!t)t=1;this.closeAutocomplete();this.options.app.searchBox.searchEvent(e);_.defer(_.bind(function(){this.options.app.searchBox.focusNextFacet(this,t,{viewPosition:this.options.order})},this))},enableEdit:function(){if(this.modes.editing!="is"){this.setMode("is","editing");this.deselectFacet();if(this.box.val()==""){this.box.val(this.model.get("value"))}}this.flags.canClose=false;this.options.app.searchBox.disableFacets(this);this.options.app.searchBox.addFocus();_.defer(_.bind(function(){this.options.app.searchBox.addFocus()},this));this.resize();this.searchAutocomplete();this.box.focus()},deferDisableEdit:function(){this.flags.canClose=true;_.delay(_.bind(function(){if(this.flags.canClose&&!this.box.is(":focus")&&this.modes.editing=="is"&&this.modes.selected!="is"){this.disableEdit()}},this),250)},disableEdit:function(){var e=VS.utils.inflector.trim(this.box.val());if(e!=this.model.get("value")){this.set(e)}this.flags.canClose=false;this.box.selectRange(0,0);this.box.blur();this.setMode("not","editing");this.closeAutocomplete();this.options.app.searchBox.removeFocus()},selectFacet:function(t){if(t)t.preventDefault();var n=this.options.app.searchBox.allSelected();if(this.modes.selected=="is")return;if(this.box.is(":focus")){this.box.setCursorPosition(0);this.box.blur()}this.flags.canClose=false;this.closeAutocomplete();this.setMode("is","selected");this.setMode("not","editing");if(!n||t){e(document).unbind("keydown.facet",this.keydown);e(document).unbind("click.facet",this.deselectFacet);_.defer(_.bind(function(){e(document).unbind("keydown.facet").bind("keydown.facet",this.keydown);e(document).unbind("click.facet").one("click.facet",this.deselectFacet)},this));this.options.app.searchBox.disableFacets(this);this.options.app.searchBox.addFocus()}return false},deselectFacet:function(t){if(t)t.preventDefault();if(this.modes.selected=="is"){this.setMode("not","selected");this.closeAutocomplete();this.options.app.searchBox.removeFocus()}e(document).unbind("keydown.facet",this.keydown);e(document).unbind("click.facet",this.deselectFacet);return false},isFocused:function(){return this.box.is(":focus")},showDelete:function(){e(this.el).addClass("search_facet_maybe_delete")},hideDelete:function(){e(this.el).removeClass("search_facet_maybe_delete")},setCursorAtEnd:function(e){if(e==-1){this.box.setCursorPosition(this.box.val().length)}else{this.box.setCursorPosition(0)}},remove:function(e){var t=this.model.get("value");this.deselectFacet();this.disableEdit();this.options.app.searchQuery.remove(this.model);if(t&&this.options.app.options.autosearch){this.search(e,0)}else{this.options.app.searchBox.renderFacets();this.options.app.searchBox.focusNextFacet(this,-1,{viewPosition:this.options.order})}},selectText:function(){this.box.selectRange(0,this.box.val().length)},keydown:function(e){var t=VS.app.hotkeys.key(e);if(t=="enter"&&this.box.val()){this.disableEdit();this.search(e)}else if(t=="left"){if(this.modes.selected=="is"){this.deselectFacet();this.options.app.searchBox.focusNextFacet(this,-1,{startAtEnd:-1})}else if(this.box.getCursorPosition()==0&&!this.box.getSelection().length){this.selectFacet()}}else if(t=="right"){if(this.modes.selected=="is"){e.preventDefault();this.deselectFacet();this.setCursorAtEnd(0);this.enableEdit()}else if(this.box.getCursorPosition()==this.box.val().length){e.preventDefault();this.disableEdit();this.options.app.searchBox.focusNextFacet(this,1)}}else if(VS.app.hotkeys.shift&&t=="tab"){e.preventDefault();this.options.app.searchBox.focusNextFacet(this,-1,{startAtEnd:-1,skipToFacet:true,selectText:true})}else if(t=="tab"){e.preventDefault();this.options.app.searchBox.focusNextFacet(this,1,{skipToFacet:true,selectText:true})}else if(VS.app.hotkeys.command&&(e.which==97||e.which==65)){e.preventDefault();this.options.app.searchBox.selectAllFacets();return false}else if(VS.app.hotkeys.printable(e)&&this.modes.selected=="is"){this.options.app.searchBox.focusNextFacet(this,-1,{startAtEnd:-1});this.remove(e)}else if(t=="backspace"){if(this.modes.selected=="is"){e.preventDefault();this.remove(e)}else if(this.box.getCursorPosition()==0&&!this.box.getSelection().length){e.preventDefault();this.selectFacet()}}if(e.which==null){_.defer(_.bind(this.resize,this,e))}else{this.resize(e)}}})})();(function(){var e=jQuery;VS.ui.SearchInput=Backbone.View.extend({type:"text",className:"search_input ui-menu",events:{"keypress input":"keypress","keydown input":"keydown","click input":"maybeTripleClick","dblclick input":"startTripleClickTimer"},initialize:function(){this.app=this.options.app;this.flags={canClose:false};_.bindAll(this,"removeFocus","addFocus","moveAutocomplete","deferDisableEdit")},render:function(){e(this.el).html(JST["search_input"]({}));this.setMode("not","editing");this.setMode("not","selected");this.box=this.$("input");this.box.autoGrowInput();this.box.bind("updated.autogrow",this.moveAutocomplete);this.box.bind("blur",this.deferDisableEdit);this.box.bind("focus",this.addFocus);this.setupAutocomplete();return this},setupAutocomplete:function(){this.box.autocomplete({minLength:this.options.showFacets?0:1,delay:50,autoFocus:true,position:{offset:"0 -1"},source:_.bind(this.autocompleteValues,this),create:_.bind(function(t,n){e(this.el).find(".ui-autocomplete-input").css("z-index","auto")},this),select:_.bind(function(e,t){e.preventDefault();var n=this.addTextFacetRemainder(t.item.value);var r=this.options.position+(n?1:0);this.app.searchBox.addFacet(t.item instanceof String?t.item:t.item.value,"",r);return false},this)});this.box.data("uiAutocomplete")._renderMenu=function(e,t){var n="";_.each(t,_.bind(function(t,r){if(t.category&&t.category!=n){e.append('<li class="ui-autocomplete-category">'+t.category+"</li>");n=t.category}if(this._renderItemData){this._renderItemData(e,t)}else{this._renderItem(e,t)}},this))};this.box.autocomplete("widget").addClass("VS-interface")},autocompleteValues:function(t,n){var r=t.term;var i=r.match(/\w+\*?$/);var s=VS.utils.inflector.escapeRegExp(i&&i[0]||"");this.app.options.callbacks.facetMatches(function(t,r){r=r||{};t=t||[];var i=new RegExp("^"+s,"i");var o=e.grep(t,function(e){return e&&i.test(e.label||e)});if(r.preserveOrder){n(o)}else{n(_.sortBy(o,function(e){if(e.label)return e.category+"-"+e.label;else return e}))}})},closeAutocomplete:function(){var e=this.box.data("uiAutocomplete");if(e)e.close()},moveAutocomplete:function(){var e=this.box.data("uiAutocomplete");if(e){e.menu.element.position({my:"left top",at:"left bottom",of:this.box.data("uiAutocomplete").element,collision:"none",offset:"0 -1"})}},searchAutocomplete:function(e){var t=this.box.data("uiAutocomplete");if(t){var n=t.menu.element;t.search();n.outerWidth(Math.max(n.width("").outerWidth(),t.element.outerWidth()))}},addTextFacetRemainder:function(e){var t=this.box.val();var n=t.match(/\b(\w+)$/);if(!n){return""}var r=new RegExp(n[0],"i");if(e.search(r)==0){t=t.replace(/\b(\w+)$/,"")}t=t.replace("^s+|s+$","");if(t){this.app.searchBox.addFacet(this.app.options.remainder,t,this.options.position)}return t},enableEdit:function(e){this.addFocus();if(e){this.selectText()}this.box.focus()},addFocus:function(){this.flags.canClose=false;if(!this.app.searchBox.allSelected()){this.app.searchBox.disableFacets(this)}this.app.searchBox.addFocus();this.setMode("is","editing");this.setMode("not","selected");if(!this.app.searchBox.allSelected()){this.searchAutocomplete()}},disableEdit:function(){this.box.blur();this.removeFocus()},removeFocus:function(){this.flags.canClose=false;this.app.searchBox.removeFocus();this.setMode("not","editing");this.setMode("not","selected");this.closeAutocomplete()},deferDisableEdit:function(){this.flags.canClose=true;_.delay(_.bind(function(){if(this.flags.canClose&&!this.box.is(":focus")&&this.modes.editing=="is"){this.disableEdit()}},this),250)},startTripleClickTimer:function(){this.tripleClickTimer=setTimeout(_.bind(function(){this.tripleClickTimer=null},this),500)},maybeTripleClick:function(e){if(!!this.tripleClickTimer){e.preventDefault();this.app.searchBox.selectAllFacets();return false}},isFocused:function(){return this.box.is(":focus")},value:function(){return this.box.val()},setCursorAtEnd:function(e){if(e==-1){this.box.setCursorPosition(this.box.val().length)}else{this.box.setCursorPosition(0)}},selectText:function(){this.box.selectRange(0,this.box.val().length);if(!this.app.searchBox.allSelected()){this.box.focus()}else{this.setMode("is","selected")}},search:function(e,t){if(!t)t=0;this.closeAutocomplete();this.app.searchBox.searchEvent(e);_.defer(_.bind(function(){this.app.searchBox.focusNextFacet(this,t)},this))},keypress:function(e){var t=VS.app.hotkeys.key(e);if(t=="enter"){return this.search(e,100)}else if(VS.app.hotkeys.colon(e)){this.box.trigger("resize.autogrow",e);var n=this.box.val();var r=[];if(this.app.options.callbacks.facetMatches){this.app.options.callbacks.facetMatches(function(e){r=e})}var i=_.map(r,function(e){if(e.label)return e.label;else return e});if(_.contains(i,n)){e.preventDefault();var s=this.addTextFacetRemainder(n);var o=this.options.position+(s?1:0);this.app.searchBox.addFacet(n,"",o);return false}}else if(t=="backspace"){if(this.box.getCursorPosition()==0&&!this.box.getSelection().length){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();this.app.searchBox.resizeFacets();return false}}},keydown:function(e){var t=VS.app.hotkeys.key(e);if(t=="left"){if(this.box.getCursorPosition()==0){e.preventDefault();this.app.searchBox.focusNextFacet(this,-1,{startAtEnd:-1})}}else if(t=="right"){if(this.box.getCursorPosition()==this.box.val().length){e.preventDefault();this.app.searchBox.focusNextFacet(this,1,{selectFacet:true})}}else if(VS.app.hotkeys.shift&&t=="tab"){e.preventDefault();this.app.searchBox.focusNextFacet(this,-1,{selectText:true})}else if(t=="tab"){var n=this.box.val();if(n.length){e.preventDefault();var r=this.addTextFacetRemainder(n);var i=this.options.position+(r?1:0);if(n!=r){this.app.searchBox.addFacet(n,"",i)}}else{var s=this.app.searchBox.focusNextFacet(this,0,{skipToFacet:true,selectText:true});if(s){e.preventDefault()}}}else if(VS.app.hotkeys.command&&String.fromCharCode(e.which).toLowerCase()=="a"){e.preventDefault();this.app.searchBox.selectAllFacets();return false}else if(t=="backspace"&&!this.app.searchBox.allSelected()){if(this.box.getCursorPosition()==0&&!this.box.getSelection().length){e.preventDefault();this.app.searchBox.focusNextFacet(this,-1,{backspace:true});return false}}else if(t=="end"){var o=this.app.searchBox.inputViews[this.app.searchBox.inputViews.length-1];o.setCursorAtEnd(-1)}else if(t=="home"){var o=this.app.searchBox.inputViews[0];o.setCursorAtEnd(-1)}this.box.trigger("resize.autogrow",e)}})})();(function(){var e=jQuery;Backbone.View.prototype.setMode=function(t,n){this.modes||(this.modes={});if(this.modes[n]===t)return;e(this.el).setMode(t,n);this.modes[n]=t}})();(function(){var e=jQuery;VS.app.hotkeys={KEYS:{16:"shift",17:"command",91:"command",93:"command",224:"command",13:"enter",37:"left",38:"upArrow",39:"right",40:"downArrow",46:"delete",8:"backspace",35:"end",36:"home",9:"tab",188:"comma"},initialize:function(){_.bindAll(this,"down","up","blur");e(document).bind("keydown",this.down);e(document).bind("keyup",this.up);e(window).bind("blur",this.blur)},down:function(e){var t=this.KEYS[e.which];if(t)this[t]=true},up:function(e){var t=this.KEYS[e.which];if(t)this[t]=false},blur:function(e){for(var t in this.KEYS)this[this.KEYS[t]]=false},key:function(e){return this.KEYS[e.which]},colon:function(e){var t=e.which;return t&&String.fromCharCode(t)==":"},printable:function(e){var t=e.which;if(e.type=="keydown"){if(t==32||t>=48&&t<=90||t>=96&&t<=111||t>=186&&t<=192||t>=219&&t<=222){return true}}else{if(t>=32&&t<=126||t>=160&&t<=500||String.fromCharCode(t)==":"){return true}}return false}}})();(function(){var e=jQuery;VS.utils.inflector={trim:function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},escapeRegExp:function(e){return e.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1")}}})();(function(){var e=jQuery;e.fn.extend({setMode:function(e,t){t=t||"mode";var n=new RegExp("\\w+_"+t+"(\\s|$)","g");var r=e===null?"":e+"_"+t;this.each(function(){this.className=(this.className.replace(n,"")+" "+r).replace(/\s\s/g," ")});return r},autoGrowInput:function(){return this.each(function(){var t=e(this);var n=e("<div />").css({opacity:0,top:-9999,left:-9999,position:"absolute",whiteSpace:"nowrap"}).addClass("VS-input-width-tester").addClass("VS-interface");var r="keydown.autogrow keypress.autogrow "+"resize.autogrow change.autogrow";t.next(".VS-input-width-tester").remove();t.after(n);t.unbind(r).bind(r,function(e,r){if(r)e=r;var i=t.val();if(VS.app.hotkeys.key(e)=="backspace"){var s=t.getCursorPosition();if(s>0)i=i.slice(0,s-1)+i.slice(s,i.length)}else if(VS.app.hotkeys.printable(e)&&!VS.app.hotkeys.command){i+=String.fromCharCode(e.which)}i=i.replace(/&/g,"&").replace(/\s/g," ").replace(/</g,"<").replace(/>/g,">");n.html(i);t.width(n.width()+3+parseInt(t.css("min-width")));t.trigger("updated.autogrow")});t.trigger("resize.autogrow")})},getCursorPosition:function(){var t=0;var n=this.get(0);if(document.selection){n.focus();var r=document.selection.createRange();var i=document.selection.createRange().text.length;r.moveStart("character",-n.value.length);t=r.text.length-i}else if(n&&e(n).is(":visible")&&n.selectionStart!=null){t=n.selectionStart}return t},setCursorPosition:function(t){return this.each(function(){return e(this).selectRange(t,t)})},selectRange:function(e,t){return this.filter(":visible").each(function(){if(this.setSelectionRange){this.focus();this.setSelectionRange(e,t)}else if(this.createTextRange){var n=this.createTextRange();n.collapse(true);n.moveEnd("character",t);n.moveStart("character",e);if(t-e>=0)n.select()}})},getSelection:function(){var e=this[0];if(e.selectionStart!=null){var t=e.selectionStart;var n=e.selectionEnd;return{start:t,end:n,length:n-t,text:e.value.substr(t,n-t)}}else if(document.selection){var r=document.selection.createRange();if(r){var i=e.createTextRange();var s=i.duplicate();i.moveToBookmark(r.getBookmark());s.setEndPoint("EndToStart",i);var t=s.text.length;var n=t+r.text.length;return{start:t,end:n,length:n-t,text:r.text}}}return{start:0,end:0,length:0}}})})();(function(){var e=jQuery;var t="('[^']+'|\"[^\"]+\")";var n="('[^']+'|\"[^\"]+\"|[^'\"\\s]\\S*)";var r=n+":\\s*";VS.app.SearchParser={ALL_FIELDS:new RegExp(r+n,"g"),CATEGORY:new RegExp(r),parse:function(e,t){var n=this._extractAllFacets(e,t);e.searchQuery.reset(n);return n},_extractAllFacets:function(e,t){var n=[];var r=t;while(t){var i,s;r=t;var o=this._extractNextField(t);if(!o){i=e.options.remainder;s=this._extractSearchText(t);t=VS.utils.inflector.trim(t.replace(s,""))}else if(o.indexOf(":")!=-1){i=o.match(this.CATEGORY)[1].replace(/(^['"]|['"]$)/g,"");s=o.replace(this.CATEGORY,"").replace(/(^['"]|['"]$)/g,"");t=VS.utils.inflector.trim(t.replace(o,""))}else if(o.indexOf(":")==-1){i=e.options.remainder;s=o;t=VS.utils.inflector.trim(t.replace(s,""))}if(i&&s){var u=new VS.model.SearchFacet({category:i,value:VS.utils.inflector.trim(s),app:e});n.push(u)}if(r==t)break}return n},_extractNextField:function(e){var r=new RegExp("^\\s*(\\S+)\\s+(?="+t+n+")");var i=e.match(r);if(i&&i.length>=1){return i[1]}else{return this._extractFirstField(e)}},_extractFirstField:function(e){var t=e.match(this.ALL_FIELDS);return t&&t.length&&t[0]},_extractSearchText:function(e){e=e||"";var t=VS.utils.inflector.trim(e.replace(this.ALL_FIELDS,""));return t}}})();(function(){var e=jQuery;VS.model.SearchFacet=Backbone.Model.extend({serialize:function(){var e=this.quoteCategory(this.get("category"));var t=VS.utils.inflector.trim(this.get("value"));var n=this.get("app").options.remainder;if(!t)return"";if(!_.contains(this.get("app").options.unquotable||[],e)&&e!=n){t=this.quoteValue(t)}if(e!=n){e=e+": "}else{e=""}return e+t},quoteCategory:function(e){var t=/"/.test(e);var n=/'/.test(e);var r=/\s/.test(e);if(t&&!n){return"'"+e+"'"}else if(r||n&&!t){return'"'+e+'"'}else{return e}},quoteValue:function(e){var t=/"/.test(e);var n=/'/.test(e);if(t&&!n){return"'"+e+"'"}else{return'"'+e+'"'}},label:function(){return this.get("label")||this.get("value")}})})();(function(){var e=jQuery;VS.model.SearchQuery=Backbone.Collection.extend({model:VS.model.SearchFacet,serialize:function(){return this.map(function(e){return e.serialize()}).join(" ")},facets:function(){return this.map(function(e){var t={};t[e.get("category")]=e.get("value");return t})},find:function(e){var t=this.detect(function(t){return t.get("category").toLowerCase()==e.toLowerCase()});return t&&t.get("value")},count:function(e){return this.select(function(t){return t.get("category").toLowerCase()==e.toLowerCase()}).length},values:function(e){var t=this.select(function(t){return t.get("category").toLowerCase()==e.toLowerCase()});return _.map(t,function(e){return e.get("value")})},has:function(e,t){return this.any(function(n){var r=n.get("category").toLowerCase()==e.toLowerCase();if(!t)return r;return r&&n.get("value")==t})},withoutCategory:function(){var e=_.map(_.toArray(arguments),function(e){return e.toLowerCase()});return this.map(function(t){if(!_.include(e,t.get("category").toLowerCase())){return t.serialize()}}).join(" ")}})})();(function(){window.JST=window.JST||{};window.JST["search_box"]=_.template('<div class="VS-search">\n  <div class="VS-search-box-wrapper VS-search-box">\n    <div class="VS-icon VS-icon-search"></div>\n    <div class="VS-placeholder"></div>\n    <div class="VS-search-inner"></div>\n    <div class="VS-icon VS-icon-cancel VS-cancel-search-box" title="clear search"></div>\n  </div>\n</div>');window.JST["search_facet"]=_.template('<% if (model.has(\'category\')) { %>\n  <div class="category"><%= model.get(\'category\') %>:</div>\n<% } %>\n\n<div class="search_facet_input_container">\n  <input type="text" class="search_facet_input ui-menu VS-interface" value="" />\n</div>\n\n<div class="search_facet_remove VS-icon VS-icon-cancel"></div>');window.JST["search_input"]=_.template('<input type="text" class="ui-menu" />')})()